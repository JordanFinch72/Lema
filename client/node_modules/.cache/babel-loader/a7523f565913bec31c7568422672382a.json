{"ast":null,"code":"var _jsxFileName = \"D:\\\\xampp\\\\htdocs\\\\COMP3000_LEMA\\\\client\\\\src\\\\Lema.js\";\nimport \"./css/Lema.css\";\nimport { Component } from \"react\";\nimport axios from \"axios\";\nimport { useJwt } from \"react-jwt\";\nimport { Banner } from \"./components/Banner\";\nimport { LeftBar } from \"./components/LeftBar\";\nimport { Map } from \"./components/Map\";\nimport { ViewMapsModal } from \"./components/modals/ViewMapsModal\";\nimport { Toast } from \"./components/Toast\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nconst jwt = require(\"jsonwebtoken\");\n\nclass Lema extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      activeToast: null,\n      // Either null or a React component\n      activeModal: null,\n      // Either null or a React component\n      activeContextMenu: null,\n      // Either null or a React component\n      activeUser: null,\n      // Set upon user login\n      activeMap: null,\n      // Either null, set by load function, or set by save function once saved to profile\n      collections: [],\n      journeyCount: 0,\n      isShowcaseMode: false\n    };\n    this.toastTimeout = null;\n    this.defaultJourneyColours = [\"#ff0000\", \"#00ff00\", \"#0000ff\", \"#da35aa\", \"#ffcc00\"]; // TODO: Better colours\n\n    this.flattenTree = this.flattenTree.bind(this);\n    this.createToast = this.createToast.bind(this);\n    this.openModal = this.openModal.bind(this);\n    this.closeModal = this.closeModal.bind(this);\n    this.openContextMenu = this.openContextMenu.bind(this);\n    this.closeContextMenu = this.closeContextMenu.bind(this);\n    this.addCollection = this.addCollection.bind(this);\n    this.editCollection = this.editCollection.bind(this);\n    this.addJourneyFromDatabase = this.addJourneyFromDatabase.bind(this);\n    this.addNode = this.addNode.bind(this);\n    this.editNode = this.editNode.bind(this);\n    this.removeNode = this.removeNode.bind(this);\n    this.removeCollection = this.removeCollection.bind(this);\n    this.authenticateUser = this.authenticateUser.bind(this);\n    this.registerUser = this.registerUser.bind(this);\n    this.logoutUser = this.logoutUser.bind(this);\n    this.editProfile = this.editProfile.bind(this);\n    this.deleteProfile = this.deleteProfile.bind(this);\n    this.toggleShowcaseMode = this.toggleShowcaseMode.bind(this);\n    this.newMap = this.newMap.bind(this);\n    this.saveMap = this.saveMap.bind(this);\n    this.loadMap = this.loadMap.bind(this);\n    this.deleteMap = this.deleteMap.bind(this);\n    this.handleResponse = this.handleResponse.bind(this);\n  }\n  /**\r\n   * As part of React's lifecycle, this function is automatically called once the component is rendered (\"mounted\"),\r\n   * i.e. at page load/refresh (when the component is created).\r\n   */\n\n\n  componentDidMount() {\n    // Check if user is already logged in\n    const activeUser = JSON.parse(localStorage.getItem(\"LEMA_activeUser\"));\n    if (activeUser) this.setState({\n      activeUser: activeUser\n    }); // Check if user has been linked a map\n\n    const urlParts = window.location.href.split('/');\n\n    if (urlParts.includes(\"map\")) {\n      const userConfirmed = window.confirm(\"You are loading another person's map.\\nThis will overwrite your currently active map.\\n\\n\" + \"Do you wish to continue?\");\n\n      if (userConfirmed) {\n        const username = urlParts[4];\n        const mapID = urlParts[5];\n        axios.get(`/maps/${username}/${mapID}`).then(response => {\n          if (this.handleResponse(response, \"User's map retrieved.\", null)) {\n            this.loadMap(null, response.data.map, \"database\");\n          }\n        });\n      }\n    } else {\n      // Check for activeMap data (mapID, title, description, isShared)\n      const activeMap = JSON.parse(localStorage.getItem(\"LEMA_activeMap\"));\n      if (activeMap) this.setState({\n        activeMap: activeMap\n      }); // Check if there are active collections (DISTINCT FROM activeMap!)\n\n      const activeCollections = JSON.parse(localStorage.getItem(\"LEMA_activeCollections\"));\n      if (activeCollections) this.setState({\n        collections: activeCollections.collections,\n        journeyCount: activeCollections.journeyCount\n      }, function () {\n        /* Repair parent links: memory references are lost when serialising to and from JSON string */\n\n        /* Justification for O(n^4): this callback function only runs once when user refreshes/re-enters the page;\r\n        and the arrays involved will never be large enough for it to be an issue. Future solution: autosave to PouchDB. */\n        for (let i = 0; i < this.state.collections.length; ++i) // Loop through collections\n        {\n          const collection = this.state.collections[i];\n\n          for (let j = 0; j < collection.words.length; ++j) // Loop through words\n          {\n            const word = collection.words[j];\n\n            for (let n = 0; n < word.parents.length; ++n) // Loop through parents\n            {\n              const parent = word.parents[n];\n\n              for (let x = 0; x < collection.words.length; ++x) // Loop through words again\n              {\n                const parentWord = collection.words[x];\n                if (parent.id === parentWord.id) word.parents[n] = parentWord;\n              }\n            }\n          }\n        }\n      });\n    }\n  }\n  /**\r\n   * Sends log in data to server to authenticate user.\r\n   * @param e SyntheticEvent\r\n   * @param data Login data\r\n   */\n\n\n  authenticateUser(e, data) {\n    // Check the user\n    const username = data.loginUsername;\n    const password = data.loginPassword;\n    const rememberMe = data.rememberMe;\n    axios.get(`/users/${username}/${password}`).then(response => {\n      if (this.handleResponse(response, \"User found.\", \"Login successful!\")) {\n        console.log(response);\n        const decodedToken = jwt.decode(response.data.tokens[0], {});\n        console.log(decodedToken);\n        const activeUser = {\n          username: decodedToken.username,\n          displayName: decodedToken.displayName,\n          jwt: response.data.tokens[0],\n          refreshToken: response.data.tokens[1]\n        };\n        this.setState({\n          activeUser: activeUser\n        }, () => {\n          if (rememberMe) localStorage.setItem(\"LEMA_activeUser\", JSON.stringify(activeUser));\n        });\n      }\n    });\n  }\n  /**\r\n   * Sends register data to server to create a new user profile.\r\n   * @param e SyntheticEvent\r\n   * @param data Registration data\r\n   */\n\n\n  registerUser(e, data) {\n    // Register the user\n    const {\n      displayName,\n      username,\n      password,\n      email\n    } = data;\n    axios.put(`/users/${displayName}/${username}/${password}/${email}`).then(response => {\n      this.handleResponse(response, \"User created.\", \"Profile created! You may now log in.\");\n    });\n  }\n  /**\r\n   * Logs the user out of the app.\r\n   * @param e SyntheticEvent\r\n   * @param forceLogout Whether the logout should be forced (when called by internal functions)\r\n   */\n\n\n  logoutUser(e) {\n    let forceLogout = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    let userConfirmed = false;\n    if (!forceLogout) userConfirmed = window.confirm(\"Are you sure you wish to log out? This will clear your active map data.\");\n\n    if (userConfirmed || forceLogout) {\n      localStorage.removeItem(\"LEMA_activeUser\");\n      localStorage.removeItem(\"LEMA_activeMap\");\n      localStorage.removeItem(\"LEMA_activeCollections\");\n      this.setState({\n        activeUser: null,\n        activeMap: null,\n        collections: [],\n        journeyCount: 0\n      });\n    }\n  }\n  /**\r\n   * A recursive function that flattens the nested data structure returned from the etymological database into an\r\n   * array of word nodes.\r\n   * @param wordArray Flat array of words (initially empty)\r\n   * @param edWords Object of words returned by the etymological database\r\n   * @param edStructure Original data structure returned by the etymological database\r\n   * @param edAffixes Array of affixed returned by the etymological database (used to filter out affixes)\r\n   * @param wordID The ID of the word currently being operated on in the recursive function\r\n   * @returns {array} The wordArray object, which has nodes pushed to it throughout the function\r\n   */\n\n\n  flattenTree(wordArray, edWords, edStructure, wordID) {\n    let edAffixes = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : null;\n    let parents = [],\n        wordNode = {}; // Parents\n\n    if (Object.keys(edStructure).length > 0) {\n      // Loop through parents\n      for (const wordID in edStructure) {\n        if (edAffixes !== null && !edAffixes.includes(Number(wordID)) || edAffixes == null) {\n          parents.push(wordID);\n          wordArray = this.flattenTree(wordArray, edWords, edStructure[wordID], wordID, edAffixes);\n        }\n      }\n    } // Retrieve word from ED and convert to Lema-compatible object\n\n\n    if (wordID !== null) {\n      wordNode = edWords[wordID];\n      wordNode = {\n        id: Number(wordID),\n        arrayIndex: wordArray.length,\n        word: wordNode.word,\n        language: wordNode.language_name,\n        parents: [],\n        vertex: {\n          type: \"word\",\n          customText: \"\",\n          fontColour: \"#000000\",\n          strokeColour: \"#000000\",\n          fillColour: this.defaultJourneyColours[this.state.journeyCount],\n          radius: null,\n          fontSize: null,\n          x: null,\n          y: null,\n          edgeStart: \"centre\",\n          edgeEnd: \"centre\",\n          edgeStrokeColour: \"#000000\",\n          edgeStrokeWidth: \"2px\",\n          edgeArrowheadEnabled: true,\n          edgeArrowheadStrokeColour: \"#000000\",\n          edgeArrowheadFillColour: \"#000000\"\n        }\n      };\n\n      for (let i = 0; i < parents.length; ++i) {\n        const parentID = Number(parents[i]);\n        const parent = wordArray.find(_ref => {\n          let {\n            id\n          } = _ref;\n          return id === parentID;\n        });\n\n        if (edAffixes !== null && !edAffixes.includes(parentID) || edAffixes === null) {\n          wordNode.parents.push(parent);\n        }\n      }\n\n      wordArray.push(wordNode);\n    }\n\n    return wordArray;\n  }\n  /**\r\n   * Creates a journey collection from words returned by the etymological database and automatically adds them to the existing journey collections array\r\n   * @param edWords Object of words returned by the etymological database\r\n   * @param edStructure Original data structure returned by the etymological database\r\n   * @param edAffixes Array of affixed returned by the etymological database (used to filter out affixes)\r\n   */\n\n\n  addJourneyFromDatabase(edWords, edStructure) {\n    let edAffixes = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;\n    const newCollections = this.state.collections,\n          newJourneyCount = this.state.journeyCount; // Flatten the data structure\n\n    let journeyWords = [];\n    journeyWords = this.flattenTree(journeyWords, edWords, edStructure, null, edAffixes); // Create the new journey and add it to collections\n\n    const newJourney = {\n      type: \"journey\",\n      header: {\n        word: journeyWords[journeyWords.length - 1].word,\n        language: journeyWords[journeyWords.length - 1].language\n      },\n      words: journeyWords\n    };\n    newCollections.push(newJourney);\n    this.setState({\n      collections: newCollections,\n      journeyCount: newJourneyCount + 1\n    }, function () {\n      localStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({\n        collections: newCollections,\n        journeyCount: this.state.journeyCount\n      }));\n    });\n  }\n  /**\r\n   * Creates a\r\n   * @param e SyntheticEvent\r\n   * @param contents HTML contents to be displayed in the toast.\r\n   * @param time Time in ms to keep the toast open\r\n   * @param type What type of alert the toast is showing: neutral, error, or success\r\n   */\n\n\n  createToast(e, contents) {\n    let time = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 5000;\n    let type = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : \"neutral\";\n\n    const toast = /*#__PURE__*/_jsxDEV(Toast, {\n      type: type,\n      children: contents\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 280,\n      columnNumber: 4\n    }, this);\n\n    this.setState({\n      activeToast: toast\n    }, function () {\n      window.clearTimeout(this.toastTimeout);\n      this.toastTimeout = window.setTimeout(() => {\n        this.setState({\n          activeToast: null\n        });\n      }, time);\n    });\n  }\n  /**\r\n   * Opens a modal if one is not already open.\r\n   * @param e SyntheticEvent\r\n   * @param modalComponent React component of the modal that is to be opened.\r\n   * @param forceClose Whether to close active modals first.\r\n   */\n\n\n  openModal(e, modalComponent) {\n    let forceClose = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n    if (!this.state.activeModal || forceClose) this.setState({\n      activeModal: modalComponent\n    });\n  }\n  /**\r\n   * Closes any currently-open modal.\r\n   */\n\n\n  closeModal() {\n    if (this.state.activeModal) this.setState({\n      activeModal: null\n    });\n  }\n  /**\r\n   * Opens a context menu if one is not already open.\r\n   * Note: currently, only one context menu can be active at a time. This means context menus' items must not attempt to open a context menu on themselves.\r\n   * @param e\r\n   * @param menuComponent A React component of the context menu that is to be opened.\r\n   */\n\n\n  openContextMenu(e, menuComponent) {\n    if (!this.state.activeContextMenu) this.setState({\n      activeContextMenu: menuComponent\n    });\n  }\n  /**\r\n   * Closes any currently-open context menu.\r\n   */\n\n\n  closeContextMenu() {\n    if (this.state.activeContextMenu) this.setState({\n      activeContextMenu: null\n    });\n  }\n  /**\r\n   * Toggles showcase mode.\r\n   * @param toggle Optional parameter to force showcase to switch to either true or false.\r\n   */\n\n\n  toggleShowcaseMode(e) {\n    let toggle = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n    const isShowcaseMode = toggle !== null ? toggle : !this.state.isShowcaseMode;\n    this.setState({\n      isShowcaseMode: isShowcaseMode\n    });\n  }\n  /**\r\n   * Adds a node to the specified collection in the state's collection array.\r\n   * @param e SyntheticEvent\r\n   * @param collectionIndex The index of the collection to which the new node will belong.\r\n   * @param newNode The new node.\r\n   * @param newCollectionIndex Optional parameter to set the node to a new/different collection.\r\n   */\n\n\n  addNode(e, collectionIndex, newNode) {\n    let newCollectionIndex = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : null;\n    const collectionIndexActual = newCollectionIndex !== null ? newCollectionIndex : collectionIndex; // Validation (note: node data validation exists in the AddEditNodeModal)\n\n    let errorCollector = \"\";\n\n    if (this.state.collections[collectionIndexActual].type === \"cognate\") {\n      // Check for existing language\n      for (let i = 0; i < this.state.collections[collectionIndexActual].words.length; ++i) {\n        const childNode = this.state.collections[collectionIndexActual].words[i];\n\n        if (childNode.language === newNode.language) {\n          errorCollector += \"A language can only appear in a cognate collection once.\\n\" + \"Additional cognate collections may contain a language used in another cognate collection.\";\n          break;\n        }\n      }\n    }\n\n    if (errorCollector.length > 0) this.createToast(null, errorCollector, 7000, \"error\");else {\n      // Insert new node\n      const newCollections = this.state.collections;\n      newNode.arrayIndex = newCollections[collectionIndexActual].words.length;\n      newCollections[collectionIndexActual].words.push(newNode);\n      this.setState({\n        collections: newCollections\n      }, function () {\n        localStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({\n          collections: newCollections,\n          journeyCount: this.state.journeyCount\n        }));\n        this.closeModal();\n      });\n    }\n  }\n  /**\r\n   * Updates a node in the specified collection in the state's collections array with updated data.\r\n   * @param e React SyntheticEvent\r\n   * @param collectionIndex Index of collection to which the node belongs.\r\n   * @param updatedNode The updated node to be set in the collections array.\r\n   * @param newCollectionIndex Optional parameter to set the node to a new collection.\r\n   */\n\n\n  editNode(e, collectionIndex, updatedNode) {\n    let newCollectionIndex = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : null;\n    const newCollections = this.state.collections; // Find node\n\n    const node = newCollections[collectionIndex].words[updatedNode.arrayIndex]; // Update node by reference\n\n    for (const index in updatedNode) if (node[index]) node[index] = updatedNode[index]; // Additional operations if node was moved from one collection to another\n\n\n    if (newCollectionIndex !== null) {\n      node.arrayIndex = newCollections[newCollectionIndex].words.length; // Update arrayIndex to reflect new collection\n\n      node.parents.splice(0, node.parents.length); // Clear parents\n\n      newCollections[newCollectionIndex].words.push(node); // Add node to new collection\n\n      this.removeNode(e, collectionIndex, updatedNode.arrayIndex); // Delete node from original collection\n    }\n\n    this.setState({\n      collections: newCollections\n    }, () => {\n      localStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({\n        collections: newCollections,\n        journeyCount: this.state.journeyCount\n      }));\n      this.closeModal();\n    });\n  }\n  /**\r\n   * Removes a specified node from a specified collection in the state's collections array.\r\n   * The user will be warned before deletion occurs (and will be notified of any existing parents, lest they have to add them all again).\r\n   * @param e SyntheticEvent\r\n   * @param collectionIndex Index of the collection to which the node belongs.\r\n   * @param arrayIndex Index of the node inside the specified collection.\r\n   */\n\n\n  removeNode(e, collectionIndex, arrayIndex) {\n    const newCollections = this.state.collections; // Find node\n\n    const node = newCollections[collectionIndex].words[arrayIndex];\n    let confirmed = false;\n    if (node.parents.length > 0) confirmed = window.confirm(\"Warning: this node is connected to \" + node.parents.length + \" parent nodes. The nodes will be unaffected by the deletion/move. Do you still wish to delete/move?\");else confirmed = window.confirm(\"Are you sure you wish to delete/move this node?\");\n\n    if (confirmed) {\n      newCollections[collectionIndex].words.splice(arrayIndex, 1); // Delete node\n\n      for (let i = 0; i < newCollections[collectionIndex].words.length; ++i) {\n        const word = newCollections[collectionIndex].words[i];\n        if (word.arrayIndex > arrayIndex) word.arrayIndex = word.arrayIndex - 1; // Shift down after splice\n        // Delete node in parents array of others (as splice() does not delete by reference)\n\n        for (let j = 0; j < word.parents.length; ++j) {\n          if (word.parents[j].id === node.id) {\n            word.parents.splice(j, 1);\n          }\n        }\n      }\n    }\n\n    this.setState({\n      collections: newCollections\n    }, function () {\n      localStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({\n        collections: newCollections,\n        journeyCount: this.state.journeyCount\n      }));\n      this.closeModal();\n    });\n  }\n  /**\r\n   * Adds a new collection to the state's collection array.\r\n   * @param e SyntheticEvent\r\n   * @param data An object containing the data required to build the new collection (collection object).\r\n   */\n\n\n  addCollection(e, data) {\n    const newCollections = this.state.collections;\n    let newJourneyCount = this.state.journeyCount; // Only one cognate allowed, for now // TODO\n\n    if (data.type === \"cognate\" && newCollections.find(e => e.type === \"cognate\") !== undefined) this.createToast(e, \"Support for multiple cognate collections coming soon!\");else {\n      if (data.type === \"journey\") newJourneyCount += 1;\n      newCollections.push({\n        type: data.type,\n        header: data.header,\n        words: []\n      });\n      this.setState({\n        collections: newCollections,\n        journeyCount: newJourneyCount\n      }, function () {\n        localStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({\n          collections: newCollections,\n          journeyCount: this.state.journeyCount\n        }));\n        this.closeModal();\n      });\n    }\n  }\n  /**\r\n   * Updates an existing collection in the state's collection array with updated data.\r\n   * @param e SyntheticEvent\r\n   * @param data An object containing the data required to update the existing collection (collection object, collection index).\r\n   */\n\n\n  editCollection(e, data) {\n    const newCollections = this.state.collections;\n    newCollections[data.index].type = data.type;\n    newCollections[data.index].header = data.header;\n    this.setState({\n      collections: newCollections\n    }, function () {\n      localStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({\n        collections: newCollections,\n        journeyCount: this.state.journeyCount\n      }));\n      this.closeModal();\n    });\n  }\n  /**\r\n   * Removes the specified collection from the state's collection array.\r\n   * @param e SyntheticEvent\r\n   * @param collectionIndex Index of the collection to be removed.\r\n   */\n\n\n  removeCollection(e, collectionIndex) {\n    const newCollections = this.state.collections;\n    let newJourneyCount = this.state.journeyCount;\n    if (newCollections[collectionIndex].type === \"journey\") newJourneyCount = this.state.journeyCount - 1;\n    newCollections.splice(collectionIndex, 1); // Remove the collection\n\n    this.setState({\n      collections: newCollections,\n      journeyCount: newJourneyCount\n    }, function () {\n      localStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({\n        collections: newCollections,\n        journeyCount: this.state.journeyCount\n      }));\n    });\n  }\n  /**\r\n   * Wipes activeMap and collections data, allowing the user to start from scratch.\r\n   * @param e SyntheticEvent\r\n   */\n\n\n  newMap(e) {\n    localStorage.removeItem(\"LEMA_activeMap\");\n    localStorage.removeItem(\"LEMA_activeCollections\");\n    window.location.href = \"/\";\n  }\n  /**\r\n   * Serialises the map to JSON then saves it in the manner specified.\r\n   * @param data User-specified data about the map (such as the title).\r\n   */\n\n\n  saveMap(e, data) {\n    const username = this.state.activeUser.username;\n    const activeMapID = this.state.activeMap ? this.state.activeMap.mapID : null;\n    const isNewMap = data.isNewMap; // Attach map data\n\n    data.mapData = {\n      collections: this.state.collections,\n      journeyCount: this.state.journeyCount\n    };\n\n    if (data.saveMode === \"Save to profile\") {\n      // Send to server\n      if (activeMapID === null || isNewMap) {\n        // Insert new map\n        axios.put(`/maps/${username}`, {\n          data: data,\n          jwt: this.state.activeUser.jwt\n        }).then(response => {\n          if (this.handleResponse(response, \"Map inserted.\", \"Map saved!\", true, () => this.saveMap(e, data))) {\n            this.setState({\n              activeMap: response.data.activeMap\n            }, function () {\n              localStorage.setItem(\"LEMA_activeMap\", JSON.stringify(this.state.activeMap));\n            }); // Set new map data returned by server\n          }\n        });\n      } else {\n        // Update map\n        axios.put(`/maps/${username}/${activeMapID}`, {\n          data: data,\n          jwt: this.state.activeUser.jwt\n        }).then(response => {\n          if (this.handleResponse(response, \"Map data updated.\", \"Map saved!\", true, () => this.saveMap(e, data))) {\n            this.setState({\n              activeMap: response.data.activeMap\n            }, function () {\n              localStorage.setItem(\"LEMA_activeMap\", JSON.stringify(this.state.activeMap));\n            }); // Set new map data returned by server\n          }\n        });\n      }\n    } else if (data.saveMode === \"Export to JSON file\") {\n      // Strip extraneous data\n      delete data.saveMode;\n      delete data.isNewMap;\n      data.mapID = null; // Set up download\n\n      const a = document.createElement(\"a\");\n      const blob = new Blob([JSON.stringify(data, null, 4)], {\n        type: 'application/json'\n      });\n      a.href = URL.createObjectURL(blob);\n      a.download = `map_${this.state.activeUser.username}_${data.title.replace(/\\s+/g, '')}`; // File name (stripped of spaces)\n\n      a.click(); // Download\n    } else if (data.saveMode === \"Export to SVG\") {\n      const svg = document.getElementById(\"map-svg\"); // Pre-processing\n\n      const map_container = document.getElementsByClassName(\"map-container\")[0];\n      const width = map_container.clientWidth,\n            height = map_container.clientHeight;\n      svg.setAttribute(\"width\", `${width}px`);\n      svg.setAttribute(\"height\", `${height}px`); // Build BLOB of SVG\n\n      const a = document.createElement(\"a\");\n      const blob = new Blob([svg.outerHTML], {\n        type: \"image/svg+xml;charset=utf-8\"\n      });\n      a.href = URL.createObjectURL(blob);\n      a.download = `map_${this.state.activeUser.username}_${data.title.replace(/\\s+/g, '')}.svg`; // File name (stripped of spaces)\n\n      a.click(); // Download\n\n      svg.removeAttribute(\"width\");\n      svg.removeAttribute(\"height\");\n    } else if (data.saveMode === \"Export to PNG\") {\n      const svg = document.getElementById(\"map-svg\"); // Pre-processing\n\n      const map_container = document.getElementsByClassName(\"map-container\")[0];\n      const width = map_container.clientWidth,\n            height = map_container.clientHeight;\n      svg.setAttribute(\"width\", `${width}px`);\n      svg.setAttribute(\"height\", `${height}px`); // Construct image data\n\n      const image = new Image();\n      const serializer = new XMLSerializer();\n      const imageString = serializer.serializeToString(svg);\n      image.src = \"data:image/svg+xml;base64, \" + window.btoa(unescape(encodeURIComponent(imageString))); // Wait until image has finished loading\n\n      image.onload = () => {\n        // Create mock canvas; draw and extract image\n        const canvas = document.createElement(\"canvas\");\n        canvas.width = width;\n        canvas.height = height;\n        canvas.getContext(\"2d\").drawImage(image, 0, 0, width, height);\n        const imageData = canvas.toDataURL(\"image/png\");\n        const a = document.createElement(\"a\");\n        a.download = `map_${this.state.activeUser.username}_${data.title.replace(/\\s+/g, '')}`; // File name (stripped of spaces)\n\n        a.href = imageData;\n        a.dataset.downloadurl = [\"image/png\", a.download, a.href].join(':');\n        a.click(); // Download\n\n        svg.removeAttribute(\"width\");\n        svg.removeAttribute(\"height\");\n      };\n    }\n  }\n  /**\r\n   * Loads the map using data returned by the server.\r\n   * @param e SyntheticEvent\r\n   * @param map The map object to be loaded.\r\n   * @param loadMode Whether the map has been loaded from the database or via user file upload.\r\n   */\n\n\n  loadMap(e, map, loadMode) {\n    // Build activeMap object if loaded from local file\n    const activeMap = loadMode === \"database\" ? map.activeMap : {\n      mapID: null,\n      title: map.title,\n      description: map.description,\n      isShared: map.isShared\n    };\n    this.setState({\n      collections: []\n    }, function () {\n      // Note: This is somewhat horrific, but the collections don't re-render otherwise\n      this.setState({\n        activeMap: activeMap,\n        collections: map.mapData.collections,\n        journeyCount: map.mapData.journeyCount\n      }, function () {\n        localStorage.setItem(\"LEMA_activeMap\", JSON.stringify(this.state.activeMap));\n        localStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({\n          collections: this.state.collections,\n          journeyCount: this.state.journeyCount\n        }));\n        this.closeModal();\n      });\n    });\n  }\n\n  deleteMap(e, mapID) {\n    const username = this.state.activeUser.username;\n    let activeMap = this.state.activeMap; // If they're deleting the currently active map\n\n    if (activeMap && Number(mapID) === Number(activeMap.mapID)) {\n      // Unset the activeMap\n      activeMap = null;\n      this.setState({\n        activeMap: activeMap\n      }, function () {\n        localStorage.removeItem(\"LEMA_activeMap\");\n      });\n    } // Delete the map\n\n\n    axios.delete(`/maps/${username}/${mapID}`, {\n      data: {\n        jwt: this.state.activeUser.jwt\n      }\n    }).then(response => {\n      this.handleResponse(response, \"Map deleted.\", null, false, () => this.deleteMap(e, mapID));\n      this.closeModal();\n      this.openModal(e, /*#__PURE__*/_jsxDEV(ViewMapsModal, {\n        loadMap: this.loadMap,\n        deleteMap: this.deleteMap,\n        activeUser: this.state.activeUser,\n        openModal: this.openModal,\n        handleResponse: this.handleResponse\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 695,\n        columnNumber: 22\n      }, this));\n    });\n  }\n\n  editProfile(e, data) {\n    const activeUser = this.state.activeUser;\n    const username = activeUser.username;\n    axios.put(`/users/${username}`, {\n      data: data,\n      jwt: this.state.activeUser.jwt\n    }).then(response => {\n      if (this.handleResponse(response, \"User profile updated.\", \"Profile updated!\", true, () => this.editProfile(e, data))) {\n        activeUser.displayName = data.displayName; // Update to reflect changes\n\n        this.setState({\n          activeUser: activeUser\n        }, () => {\n          if (localStorage.getItem(\"LEMA_activeUser\")) // Update only if they have asked to be remembered\n            localStorage.setItem(\"LEMA_activeUser\", JSON.stringify(activeUser));\n        });\n      }\n    });\n  }\n\n  deleteProfile(e) {\n    const username = this.state.activeUser.username;\n    axios.delete(`/users/${username}`, {\n      data: {\n        jwt: this.state.activeUser.jwt\n      }\n    }).then(response => {\n      if (this.handleResponse(response, \"User profile deleted.\", \"User profile deleted!\", true, () => this.deleteProfile(e))) {\n        this.setState({\n          isShowcaseMode: false\n        });\n        this.logoutUser(e, true);\n      }\n    });\n  }\n  /**\r\n   * Handles responses from axios calls\r\n   * @param response Response returned by axios call.\r\n   * @param successMessage Success message expected from server.\r\n   * @param successAlert Success message to display to user.\r\n   * @param closeModal Whether to close the active modal after the operation is complete.\r\n   * @param refreshFunction Function to call if token refresh required\r\n   * @returns true if the response was a success; \"Token refreshed\" if the JWT needed to be refreshed first\r\n   */\n\n\n  handleResponse(response, successMessage, successAlert) {\n    let closeModal = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : true;\n    let refreshFunction = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : null;\n    console.log(response);\n\n    if (response.data.type === \"error\") {\n      if (response.data.error && response.data.error.name === \"TokenExpiredError\") {\n        // Send refresh token to server to retrieve new JWT\n        let activeUser = this.state.activeUser;\n        axios.get(`jwt/refresh/${activeUser.username}/${activeUser.refreshToken}`).then(res => {\n          if (this.handleResponse(res, \"Token refreshed.\", null)) {\n            console.log(\"Token refreshed innit\");\n            activeUser = { ...activeUser,\n              jwt: res.data.tokens[0],\n              refreshToken: res.data.tokens[1]\n            };\n            this.setState({\n              activeUser: activeUser\n            }, function () {\n              if (localStorage.getItem(\"LEMA_activeUser\")) // Update only if they have asked to be remembered\n                localStorage.setItem(\"LEMA_activeUser\", JSON.stringify(activeUser));\n              if (refreshFunction !== null) refreshFunction(); // Re-call function\n              else return \"Token refreshed.\";\n            });\n          }\n        });\n      } else {\n        console.error(response.data.message);\n\n        if (response.data.message === \"Invalid refresh token.\") // Invalid refresh token is a security risk; log them out\n          {\n            this.logoutUser(null, true);\n            this.closeModal();\n          } else this.createToast(null, response.data.message, 5000, \"error\");\n      }\n    } else if (response.data.type === \"success\") {\n      console.log(response.data);\n\n      if (response.data.message === successMessage) {\n        if (successAlert) this.createToast(null, successAlert, 5000, \"success\");\n        if (closeModal) this.closeModal();\n        return true;\n      }\n    }\n  }\n\n  render() {\n    // Render any active modals and context menus\n    let toastContainer = null,\n        modalContainer = null,\n        contextMenuContainer = null;\n\n    if (this.state.activeToast !== null) {\n      const activeToast = this.state.activeToast;\n      toastContainer = /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"toast-container\",\n        children: activeToast\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 799,\n        columnNumber: 5\n      }, this);\n    }\n\n    if (this.state.activeModal !== null) {\n      const activeModal = this.state.activeModal;\n      modalContainer = /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"modal-container\",\n        onClick: e => {\n          if (e.nativeEvent.target.className === \"modal-container\") this.closeModal(); // Closes modal if they click off the modal\n        },\n        children: activeModal\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 808,\n        columnNumber: 5\n      }, this);\n    }\n\n    if (this.state.activeContextMenu !== null) {\n      const activeContextMenu = this.state.activeContextMenu;\n      contextMenuContainer = /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"context-menu-container\",\n        onClick: this.closeContextMenu,\n        onContextMenu: e => e.preventDefault(),\n        children: activeContextMenu\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 818,\n        columnNumber: 5\n      }, this);\n    }\n\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"Lema\",\n      children: [/*#__PURE__*/_jsxDEV(Banner, {\n        activeUser: this.state.activeUser,\n        openModal: this.openModal,\n        activeMap: this.state.activeMap,\n        isShowcaseMode: this.state.isShowcaseMode,\n        createToast: this.createToast,\n        handleResponse: this.handleResponse,\n        authenticateUser: this.authenticateUser,\n        registerUser: this.registerUser,\n        logoutUser: this.logoutUser,\n        editProfile: this.editProfile,\n        deleteProfile: this.deleteProfile,\n        toggleShowcaseMode: this.toggleShowcaseMode,\n        newMap: this.newMap,\n        saveMap: this.saveMap,\n        loadMap: this.loadMap,\n        deleteMap: this.deleteMap\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 823,\n        columnNumber: 5\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"main-view-container\",\n        children: [/*#__PURE__*/_jsxDEV(LeftBar, {\n          activeMap: this.state.activeMap,\n          collections: this.state.collections,\n          isShowcaseMode: this.state.isShowcaseMode,\n          createToast: this.createToast,\n          openModal: this.openModal,\n          closeModal: this.closeModal,\n          openContextMenu: this.openContextMenu,\n          closeContextMenu: this.closeContextMenu,\n          addNode: this.addNode,\n          editNode: this.editNode,\n          removeNode: this.removeNode,\n          addCollection: this.addCollection,\n          editCollection: this.editCollection,\n          removeCollection: this.removeCollection,\n          addJourneyFromDatabase: this.addJourneyFromDatabase\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 829,\n          columnNumber: 6\n        }, this), /*#__PURE__*/_jsxDEV(Map, {\n          collections: this.state.collections,\n          isShowcaseMode: this.state.isShowcaseMode,\n          createToast: this.createToast,\n          openContextMenu: this.openContextMenu,\n          closeContextMenu: this.closeContextMenu,\n          openModal: this.openModal,\n          closeModal: this.closeModal,\n          addNode: this.addNode,\n          editNode: this.editNode,\n          removeNode: this.removeNode\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 837,\n          columnNumber: 6\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 828,\n        columnNumber: 5\n      }, this), toastContainer, modalContainer, contextMenuContainer]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 822,\n      columnNumber: 4\n    }, this);\n  }\n\n}\n\nexport default Lema;","map":{"version":3,"sources":["D:/xampp/htdocs/COMP3000_LEMA/client/src/Lema.js"],"names":["Component","axios","useJwt","Banner","LeftBar","Map","ViewMapsModal","Toast","jwt","require","Lema","constructor","props","state","activeToast","activeModal","activeContextMenu","activeUser","activeMap","collections","journeyCount","isShowcaseMode","toastTimeout","defaultJourneyColours","flattenTree","bind","createToast","openModal","closeModal","openContextMenu","closeContextMenu","addCollection","editCollection","addJourneyFromDatabase","addNode","editNode","removeNode","removeCollection","authenticateUser","registerUser","logoutUser","editProfile","deleteProfile","toggleShowcaseMode","newMap","saveMap","loadMap","deleteMap","handleResponse","componentDidMount","JSON","parse","localStorage","getItem","setState","urlParts","window","location","href","split","includes","userConfirmed","confirm","username","mapID","get","then","response","data","map","activeCollections","i","length","collection","j","words","word","n","parents","parent","x","parentWord","id","e","loginUsername","password","loginPassword","rememberMe","console","log","decodedToken","decode","tokens","displayName","refreshToken","setItem","stringify","email","put","forceLogout","removeItem","wordArray","edWords","edStructure","wordID","edAffixes","wordNode","Object","keys","Number","push","arrayIndex","language","language_name","vertex","type","customText","fontColour","strokeColour","fillColour","radius","fontSize","y","edgeStart","edgeEnd","edgeStrokeColour","edgeStrokeWidth","edgeArrowheadEnabled","edgeArrowheadStrokeColour","edgeArrowheadFillColour","parentID","find","newCollections","newJourneyCount","journeyWords","newJourney","header","contents","time","toast","clearTimeout","setTimeout","modalComponent","forceClose","menuComponent","toggle","collectionIndex","newNode","newCollectionIndex","collectionIndexActual","errorCollector","childNode","updatedNode","node","index","splice","confirmed","undefined","activeMapID","isNewMap","mapData","saveMode","a","document","createElement","blob","Blob","URL","createObjectURL","download","title","replace","click","svg","getElementById","map_container","getElementsByClassName","width","clientWidth","height","clientHeight","setAttribute","outerHTML","removeAttribute","image","Image","serializer","XMLSerializer","imageString","serializeToString","src","btoa","unescape","encodeURIComponent","onload","canvas","getContext","drawImage","imageData","toDataURL","dataset","downloadurl","join","loadMode","description","isShared","delete","successMessage","successAlert","refreshFunction","error","name","res","message","render","toastContainer","modalContainer","contextMenuContainer","nativeEvent","target","className","preventDefault"],"mappings":"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","sourcesContent":["import \"./css/Lema.css\";\r\nimport {Component} from \"react\";\r\nimport axios from \"axios\";\r\nimport {useJwt} from \"react-jwt\";\r\nimport {Banner} from \"./components/Banner\";\r\nimport {LeftBar} from \"./components/LeftBar\";\r\nimport {Map} from \"./components/Map\";\r\nimport {ViewMapsModal} from \"./components/modals/ViewMapsModal\";\r\nimport {Toast} from \"./components/Toast\";\r\nconst jwt = require(\"jsonwebtoken\");\r\n\r\n\r\nclass Lema extends Component\r\n{\r\n\tconstructor(props)\r\n\t{\r\n\t\tsuper(props);\r\n\r\n\t\tthis.state = {\r\n\t\t\tactiveToast: null,       // Either null or a React component\r\n\t\t\tactiveModal: null,       // Either null or a React component\r\n\t\t\tactiveContextMenu: null, // Either null or a React component\r\n\t\t\tactiveUser: null,        // Set upon user login\r\n\t\t\tactiveMap: null,         // Either null, set by load function, or set by save function once saved to profile\r\n\t\t\tcollections: [],\r\n\t\t\tjourneyCount: 0,\r\n\t\t\tisShowcaseMode: false\r\n\t\t};\r\n\r\n\t\tthis.toastTimeout = null;\r\n\t\tthis.defaultJourneyColours = [\"#ff0000\", \"#00ff00\", \"#0000ff\", \"#da35aa\", \"#ffcc00\"] // TODO: Better colours\r\n\r\n\t\tthis.flattenTree = this.flattenTree.bind(this);\r\n\t\tthis.createToast = this.createToast.bind(this);\r\n\t\tthis.openModal = this.openModal.bind(this);\r\n\t\tthis.closeModal = this.closeModal.bind(this);\r\n\t\tthis.openContextMenu = this.openContextMenu.bind(this);\r\n\t\tthis.closeContextMenu = this.closeContextMenu.bind(this);\r\n\t\tthis.addCollection = this.addCollection.bind(this);\r\n\t\tthis.editCollection = this.editCollection.bind(this);\r\n\t\tthis.addJourneyFromDatabase = this.addJourneyFromDatabase.bind(this);\r\n\t\tthis.addNode = this.addNode.bind(this);\r\n\t\tthis.editNode = this.editNode.bind(this);\r\n\t\tthis.removeNode = this.removeNode.bind(this);\r\n\t\tthis.removeCollection = this.removeCollection.bind(this);\r\n\t\tthis.authenticateUser = this.authenticateUser.bind(this);\r\n\t\tthis.registerUser = this.registerUser.bind(this);\r\n\t\tthis.logoutUser = this.logoutUser.bind(this);\r\n\t\tthis.editProfile = this.editProfile.bind(this);\r\n\t\tthis.deleteProfile = this.deleteProfile.bind(this);\r\n\t\tthis.toggleShowcaseMode = this.toggleShowcaseMode.bind(this);\r\n\t\tthis.newMap = this.newMap.bind(this);\r\n\t\tthis.saveMap = this.saveMap.bind(this);\r\n\t\tthis.loadMap = this.loadMap.bind(this);\r\n\t\tthis.deleteMap = this.deleteMap.bind(this);\r\n\t\tthis.handleResponse = this.handleResponse.bind(this);\r\n\t}\r\n\r\n\t/**\r\n\t * As part of React's lifecycle, this function is automatically called once the component is rendered (\"mounted\"),\r\n\t * i.e. at page load/refresh (when the component is created).\r\n\t */\r\n\tcomponentDidMount()\r\n\t{\r\n\t\t// Check if user is already logged in\r\n\t\tconst activeUser = JSON.parse(localStorage.getItem(\"LEMA_activeUser\"));\r\n\t\tif(activeUser)\r\n\t\t\tthis.setState({activeUser: activeUser});\r\n\r\n\t\t// Check if user has been linked a map\r\n\t\tconst urlParts = window.location.href.split('/');\r\n\t\tif(urlParts.includes(\"map\"))\r\n\t\t{\r\n\t\t\tconst userConfirmed = window.confirm(\"You are loading another person's map.\\nThis will overwrite your currently active map.\\n\\n\" +\r\n\t\t\t\t\"Do you wish to continue?\");\r\n\t\t\tif(userConfirmed)\r\n\t\t\t{\r\n\t\t\t\tconst username = urlParts[4];\r\n\t\t\t\tconst mapID = urlParts[5];\r\n\t\t\t\taxios.get(`/maps/${username}/${mapID}`).then((response) => {\r\n\t\t\t\t\tif(this.handleResponse(response, \"User's map retrieved.\", null))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthis.loadMap(null, response.data.map, \"database\");\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// Check for activeMap data (mapID, title, description, isShared)\r\n\t\t\tconst activeMap = JSON.parse(localStorage.getItem(\"LEMA_activeMap\"));\r\n\t\t\tif(activeMap)\r\n\t\t\t\tthis.setState({activeMap: activeMap});\r\n\r\n\t\t\t// Check if there are active collections (DISTINCT FROM activeMap!)\r\n\t\t\tconst activeCollections = JSON.parse(localStorage.getItem(\"LEMA_activeCollections\"));\r\n\t\t\tif(activeCollections)\r\n\t\t\t\tthis.setState({collections: activeCollections.collections, journeyCount: activeCollections.journeyCount}, function() {\r\n\t\t\t\t\t/* Repair parent links: memory references are lost when serialising to and from JSON string */\r\n\t\t\t\t\t/* Justification for O(n^4): this callback function only runs once when user refreshes/re-enters the page;\r\n\t\t\t\t\tand the arrays involved will never be large enough for it to be an issue. Future solution: autosave to PouchDB. */\r\n\t\t\t\t\tfor(let i = 0; i < this.state.collections.length; ++i) // Loop through collections\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tconst collection = this.state.collections[i];\r\n\t\t\t\t\t\tfor(let j = 0; j < collection.words.length; ++j) // Loop through words\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tconst word = collection.words[j];\r\n\t\t\t\t\t\t\tfor(let n = 0; n < word.parents.length; ++n) // Loop through parents\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tconst parent = word.parents[n];\r\n\t\t\t\t\t\t\t\tfor(let x = 0; x < collection.words.length; ++x) // Loop through words again\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\tconst parentWord = collection.words[x];\r\n\t\t\t\t\t\t\t\t\tif(parent.id === parentWord.id)\r\n\t\t\t\t\t\t\t\t\t\tword.parents[n] = parentWord;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t}\r\n\r\n\r\n\t}\r\n\r\n\t/**\r\n\t * Sends log in data to server to authenticate user.\r\n\t * @param e SyntheticEvent\r\n\t * @param data Login data\r\n\t */\r\n\tauthenticateUser(e, data)\r\n\t{\r\n\t\t// Check the user\r\n\t\tconst username = data.loginUsername;\r\n\t\tconst password = data.loginPassword;\r\n\t\tconst rememberMe = data.rememberMe;\r\n\r\n\t\taxios.get(`/users/${username}/${password}`).then((response) => {\r\n\t\t\tif(this.handleResponse(response, \"User found.\", \"Login successful!\"))\r\n\t\t\t{\r\n\t\t\t\tconsole.log(response);\r\n\t\t\t\tconst decodedToken = jwt.decode(response.data.tokens[0], {});\r\n\t\t\t\tconsole.log(decodedToken);\r\n\t\t\t\tconst activeUser = {\r\n\t\t\t\t\tusername: decodedToken.username,\r\n\t\t\t\t\tdisplayName: decodedToken.displayName,\r\n\t\t\t\t\tjwt: response.data.tokens[0],\r\n\t\t\t\t\trefreshToken: response.data.tokens[1]\r\n\t\t\t\t};\r\n\r\n\t\t\t\tthis.setState({activeUser: activeUser}, () => {\r\n\t\t\t\t\tif(rememberMe) localStorage.setItem(\"LEMA_activeUser\", JSON.stringify(activeUser));\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\t/**\r\n\t * Sends register data to server to create a new user profile.\r\n\t * @param e SyntheticEvent\r\n\t * @param data Registration data\r\n\t */\r\n\tregisterUser(e, data)\r\n\t{\r\n\t\t// Register the user\r\n\t\tconst {displayName, username, password, email} = data;\r\n\r\n\t\taxios.put(`/users/${displayName}/${username}/${password}/${email}`).then((response) => {\r\n\t\t\tthis.handleResponse(response, \"User created.\", \"Profile created! You may now log in.\");\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Logs the user out of the app.\r\n\t * @param e SyntheticEvent\r\n\t * @param forceLogout Whether the logout should be forced (when called by internal functions)\r\n\t */\r\n\tlogoutUser(e, forceLogout = false)\r\n\t{\r\n\t\tlet userConfirmed = false;\r\n\t\tif(!forceLogout) userConfirmed = window.confirm(\"Are you sure you wish to log out? This will clear your active map data.\");\r\n\r\n\t\tif(userConfirmed || forceLogout)\r\n\t\t{\r\n\t\t\tlocalStorage.removeItem(\"LEMA_activeUser\");\r\n\t\t\tlocalStorage.removeItem(\"LEMA_activeMap\");\r\n\t\t\tlocalStorage.removeItem(\"LEMA_activeCollections\");\r\n\t\t\tthis.setState({activeUser: null, activeMap: null, collections: [], journeyCount: 0});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * A recursive function that flattens the nested data structure returned from the etymological database into an\r\n\t * array of word nodes.\r\n\t * @param wordArray Flat array of words (initially empty)\r\n\t * @param edWords Object of words returned by the etymological database\r\n\t * @param edStructure Original data structure returned by the etymological database\r\n\t * @param edAffixes Array of affixed returned by the etymological database (used to filter out affixes)\r\n\t * @param wordID The ID of the word currently being operated on in the recursive function\r\n\t * @returns {array} The wordArray object, which has nodes pushed to it throughout the function\r\n\t */\r\n\tflattenTree(wordArray, edWords, edStructure, wordID, edAffixes = null)\r\n\t{\r\n\t\tlet parents = [], wordNode = {};\r\n\t\t// Parents\r\n\t\tif(Object.keys(edStructure).length > 0)\r\n\t\t{\r\n\t\t\t// Loop through parents\r\n\t\t\tfor(const wordID in edStructure)\r\n\t\t\t{\r\n\t\t\t\tif((edAffixes !== null && !edAffixes.includes(Number(wordID)))\r\n\t\t\t\t\t|| edAffixes == null)\r\n\t\t\t\t{\r\n\t\t\t\t\tparents.push(wordID);\r\n\t\t\t\t\twordArray = this.flattenTree(wordArray, edWords, edStructure[wordID], wordID, edAffixes);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Retrieve word from ED and convert to Lema-compatible object\r\n\t\tif(wordID !== null)\r\n\t\t{\r\n\t\t\twordNode = edWords[wordID];\r\n\t\t\twordNode = {\r\n\t\t\t\tid: Number(wordID),\r\n\t\t\t\tarrayIndex: wordArray.length,\r\n\t\t\t\tword: wordNode.word,\r\n\t\t\t\tlanguage: wordNode.language_name,\r\n\t\t\t\tparents: [],\r\n\t\t\t\tvertex: {type: \"word\", customText: \"\", fontColour: \"#000000\", strokeColour: \"#000000\", fillColour: this.defaultJourneyColours[this.state.journeyCount], radius: null, fontSize: null, x: null, y: null, edgeStart: \"centre\", edgeEnd: \"centre\", edgeStrokeColour: \"#000000\", edgeStrokeWidth: \"2px\", edgeArrowheadEnabled: true, edgeArrowheadStrokeColour: \"#000000\", edgeArrowheadFillColour: \"#000000\"}\r\n\t\t\t}\r\n\t\t\tfor(let i = 0; i < parents.length; ++i)\r\n\t\t\t{\r\n\t\t\t\tconst parentID = Number(parents[i]);\r\n\t\t\t\tconst parent = wordArray.find(({id}) => id === parentID);\r\n\t\t\t\tif((edAffixes !== null && !edAffixes.includes(parentID))\r\n\t\t\t\t\t|| edAffixes === null)\r\n\t\t\t\t{\r\n\t\t\t\t\twordNode.parents.push(parent);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\twordArray.push(wordNode);\r\n\t\t}\r\n\t\treturn wordArray;\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a journey collection from words returned by the etymological database and automatically adds them to the existing journey collections array\r\n\t * @param edWords Object of words returned by the etymological database\r\n\t * @param edStructure Original data structure returned by the etymological database\r\n\t * @param edAffixes Array of affixed returned by the etymological database (used to filter out affixes)\r\n\t */\r\n\taddJourneyFromDatabase(edWords, edStructure, edAffixes = null)\r\n\t{\r\n\t\tconst newCollections = this.state.collections, newJourneyCount = this.state.journeyCount;\r\n\r\n\t\t// Flatten the data structure\r\n\t\tlet journeyWords = [];\r\n\t\tjourneyWords = this.flattenTree(journeyWords, edWords, edStructure, null, edAffixes);\r\n\r\n\t\t// Create the new journey and add it to collections\r\n\t\tconst newJourney = {type: \"journey\", header: {word: journeyWords[journeyWords.length-1].word, language: journeyWords[journeyWords.length-1].language}, words: journeyWords};\r\n\t\tnewCollections.push(newJourney);\r\n\r\n\t\tthis.setState({collections: newCollections, journeyCount: newJourneyCount+1}, function(){\r\n\t\t\tlocalStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({collections: newCollections, journeyCount: this.state.journeyCount}));\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a\r\n\t * @param e SyntheticEvent\r\n\t * @param contents HTML contents to be displayed in the toast.\r\n\t * @param time Time in ms to keep the toast open\r\n\t * @param type What type of alert the toast is showing: neutral, error, or success\r\n\t */\r\n\tcreateToast(e, contents, time = 5000, type = \"neutral\")\r\n\t{\r\n\t\tconst toast =\r\n\t\t\t<Toast type={type}>\r\n\t\t\t\t{contents}\r\n\t\t\t</Toast>\r\n\t\tthis.setState({activeToast: toast}, function(){\r\n\t\t\twindow.clearTimeout(this.toastTimeout);\r\n\t\t\tthis.toastTimeout = window.setTimeout(() => {\r\n\t\t\t\tthis.setState({activeToast: null});\r\n\t\t\t}, time);\r\n\t\t})\r\n\t}\r\n\r\n\t/**\r\n\t * Opens a modal if one is not already open.\r\n\t * @param e SyntheticEvent\r\n\t * @param modalComponent React component of the modal that is to be opened.\r\n\t * @param forceClose Whether to close active modals first.\r\n\t */\r\n\topenModal(e, modalComponent, forceClose = false)\r\n\t{\r\n\t\tif(!this.state.activeModal || forceClose)\r\n\t\t\tthis.setState({activeModal: modalComponent});\r\n\t}\r\n\r\n\t/**\r\n\t * Closes any currently-open modal.\r\n\t */\r\n\tcloseModal()\r\n\t{\r\n\t\tif(this.state.activeModal)\r\n\t\t\tthis.setState({activeModal: null});\r\n\t}\r\n\r\n\t/**\r\n\t * Opens a context menu if one is not already open.\r\n\t * Note: currently, only one context menu can be active at a time. This means context menus' items must not attempt to open a context menu on themselves.\r\n\t * @param e\r\n\t * @param menuComponent A React component of the context menu that is to be opened.\r\n\t */\r\n\topenContextMenu(e, menuComponent)\r\n\t{\r\n\t\tif(!this.state.activeContextMenu)\r\n\t\t\tthis.setState({activeContextMenu: menuComponent});\r\n\t}\r\n\r\n\t/**\r\n\t * Closes any currently-open context menu.\r\n\t */\r\n\tcloseContextMenu()\r\n\t{\r\n\t\tif(this.state.activeContextMenu)\r\n\t\t\tthis.setState({activeContextMenu: null});\r\n\t}\r\n\r\n\t/**\r\n\t * Toggles showcase mode.\r\n\t * @param toggle Optional parameter to force showcase to switch to either true or false.\r\n\t */\r\n\ttoggleShowcaseMode(e, toggle = null)\r\n\t{\r\n\t\tconst isShowcaseMode = (toggle !== null) ? toggle : !this.state.isShowcaseMode;\r\n\t\tthis.setState({isShowcaseMode: isShowcaseMode});\r\n\t}\r\n\r\n\t/**\r\n\t * Adds a node to the specified collection in the state's collection array.\r\n\t * @param e SyntheticEvent\r\n\t * @param collectionIndex The index of the collection to which the new node will belong.\r\n\t * @param newNode The new node.\r\n\t * @param newCollectionIndex Optional parameter to set the node to a new/different collection.\r\n\t */\r\n\taddNode(e, collectionIndex, newNode, newCollectionIndex = null)\r\n\t{\r\n\t\tconst collectionIndexActual = (newCollectionIndex !== null) ? newCollectionIndex : collectionIndex;\r\n\r\n\t\t// Validation (note: node data validation exists in the AddEditNodeModal)\r\n\t\tlet errorCollector = \"\";\r\n\t\tif(this.state.collections[collectionIndexActual].type === \"cognate\")\r\n\t\t{\r\n\t\t\t// Check for existing language\r\n\t\t\tfor(let i = 0; i < this.state.collections[collectionIndexActual].words.length; ++i)\r\n\t\t\t{\r\n\t\t\t\tconst childNode = this.state.collections[collectionIndexActual].words[i];\r\n\t\t\t\tif(childNode.language === newNode.language)\r\n\t\t\t\t{\r\n\t\t\t\t\terrorCollector += \"A language can only appear in a cognate collection once.\\n\" +\r\n\t\t\t\t\t\t\t\t\t  \"Additional cognate collections may contain a language used in another cognate collection.\";\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(errorCollector.length > 0)\r\n\t\t\tthis.createToast(null, errorCollector, 7000, \"error\");\r\n\t\telse\r\n\t\t{\r\n\t\t\t// Insert new node\r\n\t\t\tconst newCollections = this.state.collections;\r\n\t\t\tnewNode.arrayIndex = newCollections[collectionIndexActual].words.length;\r\n\t\t\tnewCollections[collectionIndexActual].words.push(newNode);\r\n\r\n\t\t\tthis.setState({collections: newCollections}, function(){\r\n\t\t\t\tlocalStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({collections: newCollections, journeyCount: this.state.journeyCount}));\r\n\t\t\t\tthis.closeModal();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Updates a node in the specified collection in the state's collections array with updated data.\r\n\t * @param e React SyntheticEvent\r\n\t * @param collectionIndex Index of collection to which the node belongs.\r\n\t * @param updatedNode The updated node to be set in the collections array.\r\n\t * @param newCollectionIndex Optional parameter to set the node to a new collection.\r\n\t */\r\n\teditNode(e, collectionIndex, updatedNode, newCollectionIndex = null)\r\n\t{\r\n\t\tconst newCollections = this.state.collections;\r\n\r\n\t\t// Find node\r\n\t\tconst node = newCollections[collectionIndex].words[updatedNode.arrayIndex];\r\n\r\n\t\t// Update node by reference\r\n\t\tfor(const index in updatedNode)\r\n\t\t\tif(node[index]) node[index] = updatedNode[index];\r\n\r\n\t\t// Additional operations if node was moved from one collection to another\r\n\t\tif(newCollectionIndex !== null)\r\n\t\t{\r\n\t\t\tnode.arrayIndex = newCollections[newCollectionIndex].words.length; // Update arrayIndex to reflect new collection\r\n\t\t\tnode.parents.splice(0, node.parents.length);                  // Clear parents\r\n\t\t\tnewCollections[newCollectionIndex].words.push(node);               // Add node to new collection\r\n\t\t\tthis.removeNode(e, collectionIndex, updatedNode.arrayIndex);       // Delete node from original collection\r\n\t\t}\r\n\r\n\t\tthis.setState({collections: newCollections}, () => {\r\n\t\t\tlocalStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({collections: newCollections, journeyCount: this.state.journeyCount}));\r\n\t\t\tthis.closeModal();\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Removes a specified node from a specified collection in the state's collections array.\r\n\t * The user will be warned before deletion occurs (and will be notified of any existing parents, lest they have to add them all again).\r\n\t * @param e SyntheticEvent\r\n\t * @param collectionIndex Index of the collection to which the node belongs.\r\n\t * @param arrayIndex Index of the node inside the specified collection.\r\n\t */\r\n\tremoveNode(e, collectionIndex, arrayIndex)\r\n\t{\r\n\t\tconst newCollections = this.state.collections;\r\n\r\n\t\t// Find node\r\n\t\tconst node = newCollections[collectionIndex].words[arrayIndex];\r\n\t\tlet confirmed = false;\r\n\t\tif(node.parents.length > 0)\r\n\t\t\tconfirmed = window.confirm(\"Warning: this node is connected to \"+node.parents.length+\" parent nodes. The nodes will be unaffected by the deletion/move. Do you still wish to delete/move?\");\r\n\t\telse\r\n\t\t\tconfirmed = window.confirm(\"Are you sure you wish to delete/move this node?\");\r\n\r\n\t\tif(confirmed)\r\n\t\t{\r\n\t\t\tnewCollections[collectionIndex].words.splice(arrayIndex, 1); // Delete node\r\n\r\n\t\t\tfor(let i = 0; i < newCollections[collectionIndex].words.length; ++i)\r\n\t\t\t{\r\n\t\t\t\tconst word = newCollections[collectionIndex].words[i];\r\n\t\t\t\tif(word.arrayIndex > arrayIndex) word.arrayIndex = word.arrayIndex-1; // Shift down after splice\r\n\r\n\t\t\t\t// Delete node in parents array of others (as splice() does not delete by reference)\r\n\t\t\t\tfor(let j = 0; j < word.parents.length; ++j)\r\n\t\t\t\t{\r\n\t\t\t\t\tif(word.parents[j].id === node.id)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tword.parents.splice(j, 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.setState({collections: newCollections}, function(){\r\n\t\t\tlocalStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({collections: newCollections, journeyCount: this.state.journeyCount}));\r\n\t\t\tthis.closeModal();\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Adds a new collection to the state's collection array.\r\n\t * @param e SyntheticEvent\r\n\t * @param data An object containing the data required to build the new collection (collection object).\r\n\t */\r\n\taddCollection(e, data)\r\n\t{\r\n\t\tconst newCollections = this.state.collections;\r\n\t\tlet newJourneyCount = this.state.journeyCount;\r\n\r\n\t\t// Only one cognate allowed, for now // TODO\r\n\t\tif(data.type === \"cognate\" && newCollections.find(e => e.type === \"cognate\") !== undefined)\r\n\t\t\tthis.createToast(e, \"Support for multiple cognate collections coming soon!\");\r\n\t\telse\r\n\t\t{\r\n\t\t\tif(data.type === \"journey\")\r\n\t\t\t\tnewJourneyCount += 1;\r\n\t\t\tnewCollections.push({type: data.type, header: data.header, words: []});\r\n\t\t\tthis.setState( {collections: newCollections, journeyCount: newJourneyCount}, function(){\r\n\t\t\t\tlocalStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({collections: newCollections, journeyCount: this.state.journeyCount}));\r\n\t\t\t\tthis.closeModal();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Updates an existing collection in the state's collection array with updated data.\r\n\t * @param e SyntheticEvent\r\n\t * @param data An object containing the data required to update the existing collection (collection object, collection index).\r\n\t */\r\n\teditCollection(e, data)\r\n\t{\r\n\t\tconst newCollections = this.state.collections;\r\n\t\tnewCollections[data.index].type = data.type;\r\n\t\tnewCollections[data.index].header = data.header;\r\n\r\n\t\tthis.setState({collections: newCollections}, function(){\r\n\t\t\tlocalStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({collections: newCollections, journeyCount: this.state.journeyCount}));\r\n\t\t\tthis.closeModal();\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Removes the specified collection from the state's collection array.\r\n\t * @param e SyntheticEvent\r\n\t * @param collectionIndex Index of the collection to be removed.\r\n\t */\r\n\tremoveCollection(e, collectionIndex)\r\n\t{\r\n\t\tconst newCollections = this.state.collections;\r\n\t\tlet newJourneyCount = this.state.journeyCount;\r\n\t\tif(newCollections[collectionIndex].type === \"journey\")\r\n\t\t\tnewJourneyCount = this.state.journeyCount-1;\r\n\r\n\t\tnewCollections.splice(collectionIndex, 1); // Remove the collection\r\n\r\n\t\tthis.setState({collections: newCollections, journeyCount: newJourneyCount}, function(){\r\n\t\t\tlocalStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({collections: newCollections, journeyCount: this.state.journeyCount}));\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Wipes activeMap and collections data, allowing the user to start from scratch.\r\n\t * @param e SyntheticEvent\r\n\t */\r\n\tnewMap(e)\r\n\t{\r\n\t\tlocalStorage.removeItem(\"LEMA_activeMap\");\r\n\t\tlocalStorage.removeItem(\"LEMA_activeCollections\");\r\n\t\twindow.location.href = \"/\";\r\n\t}\r\n\r\n\t/**\r\n\t * Serialises the map to JSON then saves it in the manner specified.\r\n\t * @param data User-specified data about the map (such as the title).\r\n\t */\r\n\tsaveMap(e, data)\r\n\t{\r\n\t\tconst username = this.state.activeUser.username;\r\n\t\tconst activeMapID = (this.state.activeMap) ? this.state.activeMap.mapID : null;\r\n\t\tconst isNewMap = data.isNewMap;\r\n\r\n\t\t// Attach map data\r\n\t\tdata.mapData = {collections: this.state.collections, journeyCount: this.state.journeyCount};\r\n\r\n\t\tif(data.saveMode === \"Save to profile\")\r\n\t\t{\r\n\t\t\t// Send to server\r\n\t\t\tif(activeMapID === null || isNewMap)\r\n\t\t\t{\r\n\t\t\t\t// Insert new map\r\n\t\t\t\taxios.put(`/maps/${username}`, {data: data, jwt: this.state.activeUser.jwt}).then((response) =>\r\n\t\t\t\t{\r\n\t\t\t\t\tif(this.handleResponse(response, \"Map inserted.\", \"Map saved!\", true, () => this.saveMap(e, data)))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthis.setState({activeMap: response.data.activeMap}, function(){\r\n\t\t\t\t\t\t\tlocalStorage.setItem(\"LEMA_activeMap\", JSON.stringify(this.state.activeMap));\r\n\t\t\t\t\t\t}); // Set new map data returned by server\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t// Update map\r\n\t\t\t\taxios.put(`/maps/${username}/${activeMapID}`, {data: data, jwt: this.state.activeUser.jwt}).then((response) => {\r\n\t\t\t\t\tif(this.handleResponse(response, \"Map data updated.\", \"Map saved!\", true, () => this.saveMap(e, data)))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthis.setState({activeMap: response.data.activeMap}, function(){\r\n\t\t\t\t\t\t\tlocalStorage.setItem(\"LEMA_activeMap\", JSON.stringify(this.state.activeMap));\r\n\t\t\t\t\t\t}); // Set new map data returned by server\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\telse if(data.saveMode === \"Export to JSON file\")\r\n\t\t{\r\n\t\t\t// Strip extraneous data\r\n\t\t\tdelete data.saveMode; delete data.isNewMap; data.mapID = null;\r\n\r\n\t\t\t// Set up download\r\n\t\t\tconst a = document.createElement(\"a\");\r\n\t\t\tconst blob = new Blob([JSON.stringify(data, null, 4)], {type: 'application/json'});\r\n\t\t\ta.href = URL.createObjectURL(blob);\r\n\t\t\ta.download = `map_${this.state.activeUser.username}_${data.title.replace(/\\s+/g, '')}`; // File name (stripped of spaces)\r\n\t\t\ta.click(); // Download\r\n\t\t}\r\n\t\telse if(data.saveMode === \"Export to SVG\")\r\n\t\t{\r\n\t\t\tconst svg = document.getElementById(\"map-svg\");\r\n\r\n\t\t\t// Pre-processing\r\n\t\t\tconst map_container = document.getElementsByClassName(\"map-container\")[0];\r\n\t\t\tconst width = map_container.clientWidth, height = map_container.clientHeight;\r\n\t\t\tsvg.setAttribute(\"width\", `${width}px`);\r\n\t\t\tsvg.setAttribute(\"height\", `${height}px`);\r\n\r\n\t\t\t// Build BLOB of SVG\r\n\t\t\tconst a = document.createElement(\"a\");\r\n\t\t\tconst blob = new Blob([svg.outerHTML], {type: \"image/svg+xml;charset=utf-8\"});\r\n\t\t\ta.href = URL.createObjectURL(blob);\r\n\t\t\ta.download = `map_${this.state.activeUser.username}_${data.title.replace(/\\s+/g, '')}.svg`; // File name (stripped of spaces)\r\n\t\t\ta.click(); // Download\r\n\t\t\tsvg.removeAttribute(\"width\");\r\n\t\t\tsvg.removeAttribute(\"height\");\r\n\t\t}\r\n\t\telse if(data.saveMode === \"Export to PNG\")\r\n\t\t{\r\n\t\t\tconst svg = document.getElementById(\"map-svg\");\r\n\r\n\t\t\t// Pre-processing\r\n\t\t\tconst map_container = document.getElementsByClassName(\"map-container\")[0];\r\n\t\t\tconst width = map_container.clientWidth, height = map_container.clientHeight;\r\n\t\t\tsvg.setAttribute(\"width\", `${width}px`);\r\n\t\t\tsvg.setAttribute(\"height\", `${height}px`);\r\n\r\n\t\t\t// Construct image data\r\n\t\t\tconst image = new Image();\r\n\t\t\tconst serializer = new XMLSerializer();\r\n\t\t\tconst imageString = serializer.serializeToString(svg);\r\n\t\t\t\timage.src = \"data:image/svg+xml;base64, \" + window.btoa(unescape(encodeURIComponent(imageString)));\r\n\r\n\t\t\t// Wait until image has finished loading\r\n\t\t\timage.onload = () => {\r\n\t\t\t\t// Create mock canvas; draw and extract image\r\n\t\t\t\tconst canvas = document.createElement(\"canvas\");\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tcanvas.getContext(\"2d\").drawImage(image, 0, 0, width, height);\r\n\t\t\t\tconst imageData = canvas.toDataURL(\"image/png\");\r\n\r\n\t\t\t\tconst a = document.createElement(\"a\");\r\n\t\t\t\ta.download = `map_${this.state.activeUser.username}_${data.title.replace(/\\s+/g, '')}`; // File name (stripped of spaces)\r\n\t\t\t\ta.href = imageData;\r\n\t\t\t\ta.dataset.downloadurl = [\"image/png\", a.download, a.href].join(':');\r\n\t\t\t\ta.click(); // Download\r\n\t\t\t\tsvg.removeAttribute(\"width\");\r\n\t\t\t\tsvg.removeAttribute(\"height\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Loads the map using data returned by the server.\r\n\t * @param e SyntheticEvent\r\n\t * @param map The map object to be loaded.\r\n\t * @param loadMode Whether the map has been loaded from the database or via user file upload.\r\n\t */\r\n\tloadMap(e, map, loadMode)\r\n\t{\r\n\t\t// Build activeMap object if loaded from local file\r\n\t\tconst activeMap = (loadMode === \"database\") ? map.activeMap : {\r\n\t\t\tmapID: null,\r\n\t\t\ttitle: map.title,\r\n\t\t\tdescription: map.description,\r\n\t\t\tisShared: map.isShared\r\n\t\t};\r\n\t\tthis.setState({collections: []}, function(){ // Note: This is somewhat horrific, but the collections don't re-render otherwise\r\n\t\t\tthis.setState({\r\n\t\t\t\tactiveMap: activeMap,\r\n\t\t\t\tcollections: map.mapData.collections,\r\n\t\t\t\tjourneyCount: map.mapData.journeyCount\r\n\t\t\t}, function(){\r\n\t\t\t\tlocalStorage.setItem(\"LEMA_activeMap\", JSON.stringify(this.state.activeMap));\r\n\t\t\t\tlocalStorage.setItem(\"LEMA_activeCollections\", JSON.stringify({collections: this.state.collections, journeyCount: this.state.journeyCount}));\r\n\t\t\t\tthis.closeModal();\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tdeleteMap(e, mapID)\r\n\t{\r\n\t\tconst username = this.state.activeUser.username;\r\n\t\tlet activeMap = this.state.activeMap;\r\n\r\n\t\t// If they're deleting the currently active map\r\n\t\tif(activeMap && Number(mapID) === Number(activeMap.mapID))\r\n\t\t{\r\n\t\t\t// Unset the activeMap\r\n\t\t\tactiveMap = null;\r\n\t\t\tthis.setState({activeMap: activeMap}, function(){\r\n\t\t\t\tlocalStorage.removeItem(\"LEMA_activeMap\");\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t// Delete the map\r\n\t\taxios.delete(`/maps/${username}/${mapID}`, {data: {jwt: this.state.activeUser.jwt}}).then((response) => {\r\n\t\t\tthis.handleResponse(response, \"Map deleted.\", null, false, () => this.deleteMap(e, mapID));\r\n\t\t\tthis.closeModal();\r\n\t\t\tthis.openModal(e, <ViewMapsModal loadMap={this.loadMap} deleteMap={this.deleteMap} activeUser={this.state.activeUser} openModal={this.openModal}\r\n\t\t\t                                 handleResponse={this.handleResponse}  />);\r\n\t\t});\r\n\t}\r\n\r\n\teditProfile(e, data)\r\n\t{\r\n\t\tconst activeUser = this.state.activeUser;\r\n\t\tconst username = activeUser.username;\r\n\t\taxios.put(`/users/${username}`, {data: data, jwt: this.state.activeUser.jwt}).then((response) => {\r\n\t\t\tif(this.handleResponse(response, \"User profile updated.\", \"Profile updated!\", true, () => this.editProfile(e, data)))\r\n\t\t\t{\r\n\t\t\t\tactiveUser.displayName = data.displayName; // Update to reflect changes\r\n\r\n\t\t\t\tthis.setState({activeUser: activeUser}, () => {\r\n\t\t\t\t\tif(localStorage.getItem(\"LEMA_activeUser\")) // Update only if they have asked to be remembered\r\n\t\t\t\t\t\tlocalStorage.setItem(\"LEMA_activeUser\", JSON.stringify(activeUser));\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tdeleteProfile(e)\r\n\t{\r\n\t\tconst username = this.state.activeUser.username;\r\n\t\taxios.delete(`/users/${username}`, {data: {jwt: this.state.activeUser.jwt}}).then((response) => {\r\n\t\t\tif(this.handleResponse(response, \"User profile deleted.\", \"User profile deleted!\", true, () => this.deleteProfile(e)))\r\n\t\t\t{\r\n\t\t\t\tthis.setState({isShowcaseMode: false});\r\n\t\t\t\tthis.logoutUser(e, true);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Handles responses from axios calls\r\n\t * @param response Response returned by axios call.\r\n\t * @param successMessage Success message expected from server.\r\n\t * @param successAlert Success message to display to user.\r\n\t * @param closeModal Whether to close the active modal after the operation is complete.\r\n\t * @param refreshFunction Function to call if token refresh required\r\n\t * @returns true if the response was a success; \"Token refreshed\" if the JWT needed to be refreshed first\r\n\t */\r\n\thandleResponse(response, successMessage, successAlert, closeModal = true, refreshFunction = null)\r\n\t{\r\n\t\tconsole.log(response);\r\n\t\tif(response.data.type === \"error\")\r\n\t\t{\r\n\t\t\tif(response.data.error && response.data.error.name === \"TokenExpiredError\")\r\n\t\t\t{\r\n\t\t\t\t// Send refresh token to server to retrieve new JWT\r\n\t\t\t\tlet activeUser = this.state.activeUser;\r\n\t\t\t\taxios.get(`jwt/refresh/${activeUser.username}/${activeUser.refreshToken}`).then((res) => {\r\n\t\t\t\t\tif(this.handleResponse(res, \"Token refreshed.\", null))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tconsole.log(\"Token refreshed innit\");\r\n\t\t\t\t\t\tactiveUser = {\r\n\t\t\t\t\t\t\t...activeUser,\r\n\t\t\t\t\t\t\tjwt: res.data.tokens[0],\r\n\t\t\t\t\t\t\trefreshToken: res.data.tokens[1]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.setState({activeUser: activeUser}, function(){\r\n\t\t\t\t\t\t\tif(localStorage.getItem(\"LEMA_activeUser\")) // Update only if they have asked to be remembered\r\n\t\t\t\t\t\t\t\tlocalStorage.setItem(\"LEMA_activeUser\", JSON.stringify(activeUser));\r\n\r\n\t\t\t\t\t\t\tif(refreshFunction !== null) refreshFunction(); // Re-call function\r\n\t\t\t\t\t\t\telse return \"Token refreshed.\";\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tconsole.error(response.data.message);\r\n\t\t\t\tif(response.data.message === \"Invalid refresh token.\") // Invalid refresh token is a security risk; log them out\r\n\t\t\t\t{\r\n\t\t\t\t\tthis.logoutUser(null, true);\r\n\t\t\t\t\tthis.closeModal();\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t\tthis.createToast(null, response.data.message, 5000, \"error\");\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if(response.data.type === \"success\")\r\n\t\t{\r\n\t\t\tconsole.log(response.data);\r\n\t\t\tif(response.data.message === successMessage)\r\n\t\t\t{\r\n\t\t\t\tif(successAlert) this.createToast(null, successAlert, 5000, \"success\");\r\n\t\t\t\tif(closeModal) this.closeModal();\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\trender()\r\n\t{\r\n\t\t// Render any active modals and context menus\r\n\t\tlet toastContainer = null, modalContainer = null, contextMenuContainer = null;\r\n\t\tif(this.state.activeToast !== null)\r\n\t\t{\r\n\t\t\tconst activeToast = this.state.activeToast;\r\n\t\t\ttoastContainer =\r\n\t\t\t\t<div className={\"toast-container\"}>\r\n\t\t\t\t\t{activeToast}\r\n\t\t\t\t</div>\r\n\t\t}\r\n\r\n\t\tif(this.state.activeModal !== null)\r\n\t\t{\r\n\t\t\tconst activeModal = this.state.activeModal;\r\n\t\t\tmodalContainer =\r\n\t\t\t\t<div className={\"modal-container\"} onClick={(e) => {\r\n\t\t\t\t\tif(e.nativeEvent.target.className === \"modal-container\") this.closeModal(); // Closes modal if they click off the modal\r\n\t\t\t\t}}>\r\n\t\t\t\t\t{activeModal}\r\n\t\t\t\t</div>;\r\n\t\t}\r\n\t\tif(this.state.activeContextMenu !== null)\r\n\t\t{\r\n\t\t\tconst activeContextMenu = this.state.activeContextMenu;\r\n\t\t\tcontextMenuContainer =\r\n\t\t\t\t<div className={\"context-menu-container\"} onClick={this.closeContextMenu} onContextMenu={(e) => e.preventDefault()} >{activeContextMenu}</div>;\r\n\t\t}\r\n\r\n\t\treturn (\r\n\t\t\t<div className=\"Lema\">\r\n\t\t\t\t<Banner activeUser={this.state.activeUser} openModal={this.openModal} activeMap={this.state.activeMap}\r\n\t\t\t\t        isShowcaseMode={this.state.isShowcaseMode} createToast={this.createToast} handleResponse={this.handleResponse}\r\n\t\t\t\t        authenticateUser={this.authenticateUser} registerUser={this.registerUser} logoutUser={this.logoutUser}\r\n\t\t\t\t        editProfile={this.editProfile} deleteProfile={this.deleteProfile} toggleShowcaseMode={this.toggleShowcaseMode}\r\n\t\t\t\t        newMap={this.newMap} saveMap={this.saveMap} loadMap={this.loadMap} deleteMap={this.deleteMap} />\r\n\t\t\t\t<div className={\"main-view-container\"}>\r\n\t\t\t\t\t<LeftBar activeMap={this.state.activeMap} collections={this.state.collections}\r\n\t\t\t\t\t         isShowcaseMode={this.state.isShowcaseMode} createToast={this.createToast}\r\n\t\t\t\t\t         openModal={this.openModal} closeModal={this.closeModal}\r\n\t\t\t\t\t         openContextMenu={this.openContextMenu} closeContextMenu={this.closeContextMenu}\r\n\t\t\t\t\t         addNode={this.addNode} editNode={this.editNode} removeNode={this.removeNode}\r\n\t\t\t\t\t         addCollection={this.addCollection} editCollection={this.editCollection} removeCollection={this.removeCollection}\r\n\t\t\t\t\t         addJourneyFromDatabase={this.addJourneyFromDatabase}\r\n\t\t\t\t\t/>\r\n\t\t\t\t\t<Map collections={this.state.collections}\r\n\t\t\t\t\t     isShowcaseMode={this.state.isShowcaseMode} createToast={this.createToast}\r\n\t\t\t\t\t     openContextMenu={this.openContextMenu} closeContextMenu={this.closeContextMenu}\r\n\t\t\t\t\t     openModal={this.openModal} closeModal={this.closeModal}\r\n\t\t\t\t\t\t addNode={this.addNode} editNode={this.editNode} removeNode={this.removeNode}\r\n\t\t\t\t\t/>\r\n\t\t\t\t</div>\r\n\t\t\t\t{toastContainer}\r\n\t\t\t\t{modalContainer}\r\n\t\t\t\t{contextMenuContainer}\r\n\t\t\t</div>\r\n\t\t);\r\n\t}\r\n}\r\n\r\nexport default Lema;\r\n"]},"metadata":{},"sourceType":"module"}